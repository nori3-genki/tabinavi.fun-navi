<?php
/**
 * 都道府県名修正ユーティリティ
 * 
 * 既存投稿の都道府県カテゴリを正規化
 * 
 * @package HRS
 * @version 1.0.0
 */

if (!defined('ABSPATH')) {
    exit;
}

/**
 * 都道府県名の正規化マッピング
 */
function hrs_get_prefecture_mappings() {
    return array(
        // 北海道・東北
        '北海道' => '北海道',
        '青森' => '青森県',
        '青森県' => '青森県',
        '岩手' => '岩手県',
        '岩手県' => '岩手県',
        '宮城' => '宮城県',
        '宮城県' => '宮城県',
        '秋田' => '秋田県',
        '秋田県' => '秋田県',
        '山形' => '山形県',
        '山形県' => '山形県',
        '福島' => '福島県',
        '福島県' => '福島県',
        
        // 関東
        '茨城' => '茨城県',
        '茨城県' => '茨城県',
        '栃木' => '栃木県',
        '栃木県' => '栃木県',
        '群馬' => '群馬県',
        '群馬県' => '群馬県',
        '埼玉' => '埼玉県',
        '埼玉県' => '埼玉県',
        '千葉' => '千葉県',
        '千葉県' => '千葉県',
        '東京' => '東京都',
        '東京都' => '東京都',
        '神奈川' => '神奈川県',
        '神奈川県' => '神奈川県',
        
        // 中部
        '新潟' => '新潟県',
        '新潟県' => '新潟県',
        '富山' => '富山県',
        '富山県' => '富山県',
        '石川' => '石川県',
        '石川県' => '石川県',
        '福井' => '福井県',
        '福井県' => '福井県',
        '山梨' => '山梨県',
        '山梨県' => '山梨県',
        '長野' => '長野県',
        '長野県' => '長野県',
        '岐阜' => '岐阜県',
        '岐阜県' => '岐阜県',
        '静岡' => '静岡県',
        '静岡県' => '静岡県',
        '愛知' => '愛知県',
        '愛知県' => '愛知県',
        
        // 近畿
        '三重' => '三重県',
        '三重県' => '三重県',
        '滋賀' => '滋賀県',
        '滋賀県' => '滋賀県',
        '京都' => '京都府',
        '京都府' => '京都府',
        '大阪' => '大阪府',
        '大阪府' => '大阪府',
        '兵庫' => '兵庫県',
        '兵庫県' => '兵庫県',
        '奈良' => '奈良県',
        '奈良県' => '奈良県',
        '和歌山' => '和歌山県',
        '和歌山県' => '和歌山県',
        
        // 中国
        '鳥取' => '鳥取県',
        '鳥取県' => '鳥取県',
        '島根' => '島根県',
        '島根県' => '島根県',
        '岡山' => '岡山県',
        '岡山県' => '岡山県',
        '広島' => '広島県',
        '広島県' => '広島県',
        '山口' => '山口県',
        '山口県' => '山口県',
        
        // 四国
        '徳島' => '徳島県',
        '徳島県' => '徳島県',
        '香川' => '香川県',
        '香川県' => '香川県',
        '愛媛' => '愛媛県',
        '愛媛県' => '愛媛県',
        '高知' => '高知県',
        '高知県' => '高知県',
        
        // 九州・沖縄
        '福岡' => '福岡県',
        '福岡県' => '福岡県',
        '佐賀' => '佐賀県',
        '佐賀県' => '佐賀県',
        '長崎' => '長崎県',
        '長崎県' => '長崎県',
        '熊本' => '熊本県',
        '熊本県' => '熊本県',
        '大分' => '大分県',
        '大分県' => '大分県',
        '宮崎' => '宮崎県',
        '宮崎県' => '宮崎県',
        '鹿児島' => '鹿児島県',
        '鹿児島県' => '鹿児島県',
        '沖縄' => '沖縄県',
        '沖縄県' => '沖縄県',
    );
}

/**
 * 都道府県名を正規化
 */
function hrs_normalize_prefecture($name) {
    $mappings = hrs_get_prefecture_mappings();
    return $mappings[$name] ?? $name;
}

/**
 * テキストから都道府県を抽出
 */
function hrs_extract_prefecture($text) {
    $prefectures = array(
        '北海道',
        '青森県', '岩手県', '宮城県', '秋田県', '山形県', '福島県',
        '茨城県', '栃木県', '群馬県', '埼玉県', '千葉県', '東京都', '神奈川県',
        '新潟県', '富山県', '石川県', '福井県', '山梨県', '長野県', '岐阜県', '静岡県', '愛知県',
        '三重県', '滋賀県', '京都府', '大阪府', '兵庫県', '奈良県', '和歌山県',
        '鳥取県', '島根県', '岡山県', '広島県', '山口県',
        '徳島県', '香川県', '愛媛県', '高知県',
        '福岡県', '佐賀県', '長崎県', '熊本県', '大分県', '宮崎県', '鹿児島県', '沖縄県',
    );

    foreach ($prefectures as $pref) {
        if (mb_strpos($text, $pref) !== false) {
            return $pref;
        }
    }

    // 県なし版でも検索
    $short_names = array(
        '青森', '岩手', '宮城', '秋田', '山形', '福島',
        '茨城', '栃木', '群馬', '埼玉', '千葉', '東京', '神奈川',
        '新潟', '富山', '石川', '福井', '山梨', '長野', '岐阜', '静岡', '愛知',
        '三重', '滋賀', '京都', '大阪', '兵庫', '奈良', '和歌山',
        '鳥取', '島根', '岡山', '広島', '山口',
        '徳島', '香川', '愛媛', '高知',
        '福岡', '佐賀', '長崎', '熊本', '大分', '宮崎', '鹿児島', '沖縄',
    );

    foreach ($short_names as $short) {
        if (mb_strpos($text, $short) !== false) {
            return hrs_normalize_prefecture($short);
        }
    }

    return '';
}

/**
 * 既存投稿の都道府県カテゴリを修正
 */
function hrs_fix_prefecture_categories() {
    $args = array(
        'post_type' => 'hotel-review',
        'posts_per_page' => -1,
        'post_status' => array('publish', 'draft'),
    );

    $posts = get_posts($args);
    $fixed_count = 0;

    foreach ($posts as $post) {
        $terms = wp_get_post_terms($post->ID, 'hotel_cat', array('fields' => 'names'));
        $needs_fix = false;
        $new_terms = array();

        foreach ($terms as $term) {
            $normalized = hrs_normalize_prefecture($term);
            if ($normalized !== $term) {
                $needs_fix = true;
            }
            $new_terms[] = $normalized;
        }

        if ($needs_fix) {
            wp_set_post_terms($post->ID, array_unique($new_terms), 'hotel_cat');
            $fixed_count++;
        }
    }

    return $fixed_count;
}

/**
 * AJAX: 都道府県修正実行
 */
add_action('wp_ajax_hrs_fix_prefectures', function() {
    if (!current_user_can('manage_options')) {
        wp_send_json_error('権限がありません');
    }

    $fixed = hrs_fix_prefecture_categories();
    wp_send_json_success(array(
        'fixed_count' => $fixed,
        'message' => $fixed . '件の投稿を修正しました',
    ));
});